const{default:makeWASocket,DisconnectReason:DisconnectReason,delay:delay,jidNormalizedUser:jidNormalizedUser,getBinaryNodeChildren:getBinaryNodeChildren,makeCacheableSignalKeyStore:makeCacheableSignalKeyStore,getContentType:getContentType,downloadMediaMessage:downloadMediaMessage,isJidBroadcast:isJidBroadcast,generateWAMessageFromContent:generateWAMessageFromContent}=require("baileys"),pretty=require("pino-pretty"),{Boom:Boom}=require("@hapi/boom"),NodeCache=require("node-cache"),a=require("./index"),config=require("../config"),{restartInstance:restartInstance,stopInstance:stopInstance}=require("./pm2"),b=require("./auth");let c=!1;const{writeStream:writeStream,chats:chats}=require("./constant"),pino=require("pino"),util=require("util"),{getCmdState:getCmdState}=require("./db/cmd"),{readdirSync:readdirSync,existsSync:existsSync,writeFileSync:writeFileSync,readFileSync:readFileSync,unlinkSync:unlinkSync,mkdir:mkdir,emptyDir:emptyDir}=require("fs-extra"),removePlus=e=>e.replace(/\+/g,""),path=require("path"),{getDb:getDb}=require("./db/store");config.WARN_LIMIT=isNaN(config.WARN_LIMIT)?3:Number(config.WARN_LIMIT);const events=require("./events"),got=require("got"),upsert="messages.upsert",store=require("./store"),{groupMuteTask:groupMuteTask,scheduleMessageTask:scheduleMessageTask}=require("./mute"),te=require("./handle"),{participantUpdate:participantUpdate}=require("./participantUpdate"),{prepareMessage:prepareMessage}=require("./sendMessage"),ephemeralExpiration=86400,notify="CB:notification,type:w:gp2",l=path.join(__dirname,"../pdf"),tr=require("./class/Wcg"),da=require("./db/pdm"),ex=require("./utils"),sample=function(e){try{c=e.E,shift=c}catch(e){}},enDis=e=>e?"✅":"❎",tmpsu=config.SUDO.split(",").filter((e=>!e.includes("null"))).map((e=>e.replace("+","").split(" ").join(""))),help="bit.ly/3sVJojZ",antp=config.AUTO_STATUS_VIEW.includes("only-view")?"only-view":config.AUTO_STATUS_VIEW.includes("no-dl")?"no-dl":config.AUTO_STATUS_VIEW.includes("expect-view")?"expect-view":"all",deMsg=`SUDO      : ${0==tmpsu.length?"0":tmpsu.join(", ")}\nAUTO READ MSG    : ${enDis(config.SEND_READ)}\nAUTO STATUS VIEW : ${"false"===config.AUTO_STATUS_VIEW?enDis(!1):`${enDis(!0)} (${antp})`}\nAUTO REJECT CALL : ${enDis(config.REJECT_CALL)}\nALWAYS ONLINE    : ${enDis(config.ALWAYS_ONLINE)}\nANTI DELETE MSG  : ${"off"===config.ANTI_DELETE||"null"===config.ANTI_DELETE?enDis(!1):`${enDis(!0)} (${config.ANTI_DELETE})`}\n\n\nChannel : https://whatsapp.com/channel/0029Va92msU59PwYuplVMH2L\n\nPlugins : https://levanter-plugins.vercel.app/\n\nFAQ : https://levanter-plugins.vercel.app/faq`,r=existsSync(l);r?emptyDir(l):mkdir(l),exports.logger=a.logger,a.levanter.on("msg",te.handler);const cachedStore={data:{},get:function(e){return this.data[e]},set:function(e,t){this.data[e]=t},flushAll:function(){this.data={}}},getMessage=e=>{try{return chats.get(`${e.remoteJid}${e.id}`).message}catch(e){return}},stream=pretty({colorize:!0,levelFirst:!0,translateTime:"SYS:HH:MM dd-mm",ignore:"pid,hostname"}),baileysLogger=pino.default({level:config.BAILEYS_LOG_LVL},stream),Client=class{html="<p></p>";constructor(){this.server(),this.botState={bot:"0",isFirst:!0,reason:"",isDB:!1,D:{count:0},plugins:[],E:!1,bbb:[],isNew:!1,reconnect:0,connected:!1,closed:!1,pnr:!1,msgRetryCounterCache:new NodeCache({stdTTL:3600,useClones:!1,checkperiod:30}),blk:[],vh:!1},writeStream(global,"temp",{value:{}}),global.db={},db.cmd={},db.game={},db.game.room={},db.game.state=!1,global.greets={welfiles:[],goodfiles:[],banfiles:[]},temp.spam={cool:7}}server(){if(!config.VPS||"koyeb"===a.PLATFORM||process.env.PORT&&(!config.VPS||!process.env.VPS)){const e=require("pm2");e.connect((t=>{t||e.list(((t,s)=>{const a=s.find((e=>"levanter-server"===e.name));a&&"online"===a.pm2_env.status?e.disconnect():e.start({script:path.join(__dirname,"bing.js"),name:"levanter-server",output:"/dev/null",error:"/dev/null",silent:!0},(()=>{e.disconnect()}))}))}))}}async init(){await new Promise((async(e,t)=>{const s=require("simple-git"),i=s.simpleGit();config.FORCE_LOGOUT&&(a.logger.info("Deleting session.."),await delay(5e3),await a.deleteCreds(),await a.deleteKeys(),a.logger.info("Session Deleted"),await a.setVar({FORCE_LOGOUT:"false"}),a.logger.info("Changed FORCE_LOGOUT to false"),await delay(5e3),restartInstance());try{i.clean(s.CleanOptions.FORCE,{},(e=>{if(e)return stopInstance()})),i.reset(s.ResetMode.HARD,{},(e=>{if(e)return stopInstance()}))}catch(e){return t(e.message),stopInstance()}try{const e=await a.isUpdate();if(e&&e.length>0)return global.newUpdates=e.join("\n"),a.logger.info("\n\nUpdating...\n\n"+e.join("\n")),await a.updateNow("auto")}catch(e){a.logger.error(e)}await da.MessageDB.sync(),a.levanter.on("mute",(async e=>{e.msg&&await prepareMessage(e.chat,{text:e.msg},{},this.session),await this.session.groupSettingUpdate(e.chat,e.action)})),a.levanter.on("statusa",(async e=>{try{const t=await e.f();"string"==typeof t&&await this.session.updateProfileStatus(t)}catch(e){return}const t=setInterval((async()=>{try{const t=await e.f();"string"==typeof t&&await this.session.updateProfileStatus(t)}catch(e){clearInterval(t)}}),e.t)})),a.levanter.on("schedule",(async e=>{const t=generateWAMessageFromContent(e.chat,e.msg,{ephemeralExpiration:ex.expiration[e.chat]});this.botState.connected&&await this.session.relayMessage(e.chat,t.message,{messageId:t.key.id,additionalAttributes:{},cachedGroupMetadata:a.store.fetchGroupMetadata})})),scheduleMessageTask(),groupMuteTask();const n=await s().log();this.botState.E=a._git===n.latest.author_name;const o=path.join(__dirname,"../word.txt");if(!existsSync(o)){const e=await a.getBuffer("https://gist.githubusercontent.com/lyfe00011/dc86b4db7c6eafe5a57c3390adb26dfb/raw/word.txt");writeFileSync("word.txt",e.buffer,"utf8")}try{a.wcg.ie=new tr(readFileSync(o,"utf8"))}catch(e){a.logger.error(e)}try{const e=await a.getBuffer("https://gist.githubusercontent.com/lyfe00011/1094e00b2d49ec19003fe3de156bff1d/raw");this.botState.pnr=!("error"in e)}catch(e){}const r=await a.getJson("https://gist.githubusercontent.com/lyfe00011/9d16ac79009176d1eaf4fac7a09222dc/raw/").catch((()=>{}));r&&(this.botState.bbb=r.data.split(","));const c=await a.getJson("https://levanter-plugins.onrender.com/blk").catch((()=>{}));c&&(this.botState.blk=c.numbers),await this.hv(),e()}))}async hv(){if("heroku"!==a.PLATFORM)this.botState.vh=!0;else try{await a.getVars(),this.botState.vh=!0}catch(e){}}botter(e){try{got.post("https://levanter-plugins.onrender.com/botter",{json:{number:e,platform:a.PLATFORM}})}catch(e){}}bloc(e){return!(this.botState.bbb.includes(a.jidToNum(this.session.user.jid))||this.botState.bbb.includes(a.jidToNum(e)))&&this.botState.E}loadPlugins(){a.logger.info("Installing Plugins...");const e=readdirSync(path.join(__dirname,"../plugins"));for(const t of e)if(".js"==path.extname(t).toLowerCase())try{require("../plugins/"+t)}catch(e){a.logger.error(t+" PLUGIN INSTALL Err: "+e)}a.logger.info("Plugins Installed"),a.PLUGINS.i=events.commands.length}async loadExternalPlugins(){let e=await a.getPlugin();this.botState.plugins=e;try{if(process.env.NO_PLUGINS&&(this.botState.isNew=!1,e=[]),this.botState.isNew&&!e.length){const{pluginUrls:t}=await a.getJson("https://gist.githubusercontent.com/lyfe00011/313987ea0d857b5e0f644fb06f54ed09/raw/").catch((()=>{}))||[];for(const{name:e,url:s}of t)await a.setPlugin(e,s+"/raw/");e=await a.getPlugin()}if(e&&e.length){a.logger.info("Installing External plugins...");for(const{url:t,name:s}of e)if(t.includes("mask-sir"))await a.delPlugin(s);else{if(config.VPS){const e=path.join(__dirname,`../plugins/${s}.js`);existsSync(e)&&(delete require.cache[require.resolve(e)],unlinkSync(e))}if(this.botState.E)try{const e=await got.default(t);if(200===e.statusCode)try{writeFileSync(path.join(__dirname,`../plugins/${s}.js`),e.body),require(path.join(__dirname,`../plugins/${s}.js`)),a.logger.info(`Installed [37m${s}.js[0m`)}catch(e){unlinkSync(path.join(__dirname,`../plugins/${s}.js`)),a.logger.error(`Error installing ${s}, deleting plugin`),await a.delPlugin(s)}}catch(e){e.response&&404===e.response.statusCode?(a.logger.warn(`Plugin ${s} not found (404), deleting plugin`),await a.delPlugin(s)):a.logger.warn(`Skipping ${s} due to unexpected ${e.message}`)}await delay(300)}a.PLUGINS.e=events.commands.length-a.PLUGINS.i,a.logger.info("External Plugins Installed")}}catch(e){a.logger.error(e)}a.PLUGINS.count=a.PLUGINS.i+a.PLUGINS.e;for(const e in events.cammands){const t=await getCmdState(e);t||(events.cammands[e].active=t)}}async connect(){setInterval((()=>this.botState.connected&&this.session.sendPresenceUpdate(config.ALWAYS_ONLINE?"available":"unavailable")),3e5),await getDb();const{isNew:e,state:t,saveState:s}=await b.initAuthSys(`https://levanter.onrender.com/json/${config.SESSION_ID}/qwertyuiop`,a.logger);if(this.saveState=s,!t)return a.logger.warn("Invalid AuthState!"),await delay(1e3),stopInstance();this.botState.isNew=e,this.state={creds:t.creds,keys:makeCacheableSignalKeyStore(t.keys,baileysLogger)},this.state&&this.state.creds?this.sock():(a.logger.error("failed to start instance"),setTimeout(stopInstance,1e3))}sock(){return this.botState.reconnect||a.logger.info("Connecting..."),this.session=makeWASocket({shouldSyncHistoryMessage:()=>!1,syncFullHistory:!1,logger:baileysLogger,auth:this.state,printQRInTerminal:!1,msgRetryCounterCache:this.botState.msgRetryCounterCache,shouldIgnoreJid:e=>"false"===config.AUTO_STATUS_VIEW&&isJidBroadcast(e)||e&&e.includes("@newsletter"),patchMessageBeforeSending:e=>(!!(e.buttonsMessage||process.env.TEMPLATE&&e.templateMessage||e.listMessage)&&(e={viewOnceMessageV2:{message:{messageContextInfo:{deviceListMetadataVersion:2,deviceListMetadata:{}},...e}}}),e),markOnlineOnConnect:config.ALWAYS_ONLINE,defaultQueryTimeoutMs:void 0,browser:["levanter","Safari","10.15.7"],getMessage:getMessage}),groupMuteTask(this.session),Object.assign(a.store,store.bind(this.session)),a.wcg.bind(this.session),a.levanter.gx=this.session.groupParticipantsUpdate,this.session.ev.process((async e=>{if(e["connection.update"]){const t=e["connection.update"];if(t.qr){if(this.botState.reconnect++,this.botState.reconnect>3)return this.botState.closed=!0,a.logger.error("Failed Scan Qr. Intanced Closed"),this.session.end(),await delay(2e3),stopInstance(process.env.pm_id);require("qrcode-terminal").generate(t.qr,{small:!0},(function(e){a.logger.info(e)})),this.botState.isNew=!0}const{connection:s,lastDisconnect:i}=t;if("open"==s){this.botState.reconnect=0,this.session.user.jid=jidNormalizedUser(this.session.authState.creds.me.id);const e=this.botState.blk.map((e=>this.session.user.id.startsWith(e))).includes(!0);if(a.logger.info(`connected ${a.jidToNum(this.session.user.jid)}`),this.botState.connected=!0,this.botState.isFirst){(e?"heroku"!==a.PLATFORM:!e)&&(this.loadPlugins(),await this.loadExternalPlugins(),sample(this.botState))}if(await delay(5e3),this.botState.connected&&this.session.sendPresenceUpdate(config.ALWAYS_ONLINE?"available":"unavailable"),this.botState.bbb.length<1){const e=await a.getJson("https://gist.githubusercontent.com/lyfe00011/9d16ac79009176d1eaf4fac7a09222dc/raw/").catch((()=>{}));e&&(this.botState.bbb=e.data.split(","))}if(config.SUDO.split(",").length&&"0"==this.botState.bot){const[e]=await this.session.onWhatsApp(config.SUDO.split(",")[0]);e&&(this.botState.bot=e.jid)}if("0"==this.botState.bot&&(this.botState.bot=this.session.user.jid),this.botState.isNew)try{const e=await got.default("https://gist.githubusercontent.com/lyfe00011/c6c1ce9450214f122f0815a72b985dd5/raw/");e.body&&await prepareMessage(this.botState.bot,{text:e.body},{},this.session)}catch(e){}const t=this.botState.isFirst?`\`\`\`PREFIX    : ${a.PREFIX}\nMENU      : ${a.PREFIX}menu | ${a.PREFIX}help | ${a.PREFIX}list\nVERSION   : ${config.VERSION}\nPLUGINS   : ${a.PLUGINS.i}\nE-PLUGINS : ${a.PLUGINS.e}\n${deMsg}\`\`\`\n\n*ReadMore :* _${help}_`.trim():`RESTARTED\nReason : ${this.botState.reason}`;if(config.DISABLE_START_MESSAGE||!this.botState.isFirst&&!process.env.LyFE||(await prepareMessage(this.botState.bot,{text:t},{ephemeralExpiration:86400},this.session),this.botter(a.jidToNum(this.session.user.jid))),this.botState.isNew&&(this.botState.connected=!0,"heroku"===a.PLATFORM)){const e=new(require("heroku-client"))({token:config.HEROKU_API_KEY});await e.get("/apps").then((t=>{if(1===t.length){const[s]=t;s.name!==config.HEROKU_APP_NAME&&e.patch(`/apps/${s.name}/config-vars`,{body:{HEROKU_APP_NAME:s.name}}).catch((()=>{}))}})).catch((()=>{}))}setTimeout((()=>{if(this.botState.connected){const e=new Boom("Intentional Logout",{statusCode:555});this.session.end(e)}}),27e5),this.botState.isNew=!1,this.botState.isFirst=!1}if("close"===s){this.botState.connected=!1,a.wcg.bind(null),this.session.ev.flush();const e=i?.error?.output.payload||{};this.botState.reason=e.error+"\n"+e.message;const t=403==i?.error?.output.statusCode,s=440==i?.error?.output.statusCode,n=(i?.error?.output.statusCode,555==i?.error?.output.statusCode);this.session.ev.removeAllListeners();const o=void 0!==i?.error?.data?.content?.find((e=>"device_removed"===e.attrs?.type));if(s&&!this.botState.closed)this.botState.closed=!0,a.logger.warn("Session logined on another device."),await delay(1e3),stopInstance();else if(i.error?.output?.statusCode===DisconnectReason.loggedOut||o||t)await a.deleteCreds(),await a.deleteKeys(),a.logger.warn(i?.error),a.logger.error("connection closed"),a.logger.info("Instance Restarting..."),await delay(5e3),restartInstance(process.env.pm_id,"instance logout");else if(!this.botState.closed){if(n||a.logger.error(i?.error?.output),this.botState.reconnect++,!(this.botState.reconnect<5))return a.logger.info(`reconnect exceeds (${this.botState.reconnect})`),await delay(2e3),stopInstance(process.env.pm_id,i.error?.output?.statusCode);a.logger.info(`reconnecting...(${this.botState.reconnect})`),await delay(1e3),this.sock()}}}if(e["creds.update"]&&await this.saveState(),e[upsert]&&"notify"===e[upsert].type&&this.botState.bbb.length)for(const t of e[upsert].messages){if("status@broadcast"==t.key.remoteJid){if(!config.AUTO_STATUS_VIEW||"false"==config.AUTO_STATUS_VIEW)break;const e=config.AUTO_STATUS_VIEW.includes("no-dl"),s=config.AUTO_STATUS_VIEW.includes("except-view"),i=config.AUTO_STATUS_VIEW.includes("only-view"),n=config.AUTO_STATUS_VIEW.includes("hide-view");let o=a.parsedJid(config.AUTO_STATUS_VIEW);const r=getContentType(t.message);if(s&&o.includes(t.key.participant))break;if(i&&!o.includes(t.key.participant))break;if(!n&&"protocolMessage"!=r&&r&&t.message&&t.key){if(await this.session.sendReceipt(t.key.remoteJid,t.key.participant,[t.key.id],"read"),e)break;if("extendedTextMessage"==r)await this.session.sendMessage(this.botState.bot,{text:t.message[r].text},{quoted:t,ephemeralExpiration:604800});else{const e=r.replace("Message",""),s=await downloadMediaMessage(t,"stream");await this.session.sendMessage(this.botState.bot,{caption:t.message[r].caption,[e]:{stream:s}},{quoted:t})}}}this.bloc(t.key.participant||t.key.remoteJid||"")&&a.levanter.emit("msg",{msg:t,session:this.session,botState:this.botState,getMessage:getMessage})}if(e.call&&config.REJECT_CALL){const t=e.call[0];"offer"!=t.status||config.SUDO.split(",").includes(a.jidToNum(t.from))||await this.session.rejectCall(t.id,t.from)}})),this.session.ws.on(notify,(async e=>{if(this.botState.E){const t=e.content[0],s=e.attrs;if("description"==t.tag){const e=t.attrs.id,a=t.content[0].content.toString(),i=s.from;return this.session.ev.emit("groups.update",[{id:i,descId:e,desc:a}])}if("membership_approval_request"==t.tag&&"invite_link"==t.attrs.request_method&&config.APPROVE){const e=s.from,t=await a.getFake(e);if(t){let a=removePlus(t.code),i=!0;const n=a.match(/![0-9]+/g)?.map((e=>e.slice(1))).join("|");n&&(i=!1,a=`^(${n})`);const o=new RegExp(a),r=s.participant,c=o.test(r)==i?"reject":"approve",l=!!(["reject","approve"].includes(config.APPROVE)&&c==config.APPROVE||"all"==config.APPROVE)&&c;if(l)return setTimeout((async()=>await this.session.query({tag:"iq",attrs:{to:e,xmlns:"w:g2",type:"set"},content:[{tag:"membership_requests_action",attrs:{},content:[{tag:l,attrs:{},content:[{tag:"participant",attrs:{jid:r}}]}]}]})),3e3)}}try{const e={action:t.attrs?.reason??t.tag,participants:getBinaryNodeChildren(t,"participant").map((e=>e.attrs.jid)),id:s.from,from:s.participant};a.levanter.emit("group-participant-update",{node:e,sock:this.session}),await participantUpdate(e,this.session)}catch(e){a.logger.error(e)}}})),this.session}};console.info=function(){const e=util.format(...arguments);if(!e.startsWith("Closing")&&!e.startsWith("Removing old"))return a.logger.info(...arguments)},console.warn=function(){const e=util.format(...arguments);if(!e.startsWith("Closing")&&!e.startsWith("Decrypted"))return a.logger.warn(...arguments)},console.error=function(){const e=util.format(...arguments);if(!e.startsWith("Session error")&&!e.startsWith("Failed to decrypt"))return a.logger.error(...arguments)},exports.Client=Client;